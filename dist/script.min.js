var module=noise={};function Grad(t,e,r){this.x=t,this.y=e,this.z=r}Grad.prototype.dot2=function(t,e){return this.x*t+this.y*e},Grad.prototype.dot3=function(t,e,r){return this.x*t+this.y*e+this.z*r};var grad3=[new Grad(1,1,0),new Grad(-1,1,0),new Grad(1,-1,0),new Grad(-1,-1,0),new Grad(1,0,1),new Grad(-1,0,1),new Grad(1,0,-1),new Grad(-1,0,-1),new Grad(0,1,1),new Grad(0,-1,1),new Grad(0,1,-1),new Grad(0,-1,-1)],p=new Array;for(i of atob`l6CJW1oPgw3JX2A1wukH4YwkZx5FjghjJfAVChe+BpT3eOpLABrFPl7828t1IwsgObEhWO2VOFeuFH2Iq6hEr0qlR4aLMBumTZKe51Nv5Xo804Xm3GlcKTcu9Sj0Zo82QRk/oQHYUEnRTIS70FkSqcjEh4J0vJ9WpGRtxq26A0A02eL6fHsFyiaTdn7/UlXUz8474y8QOhG2vRwq37eq1Xf4mAIsmqNG3Zllm6crrAmBFif9E2Jsbk9x4OiyuXBo2vZh5Psi8sHu0pAMv7Oi8VEzkev5Du9rMcDWH7XHap24VMywc3kyLX8Elv6K7M1d3nJDHRhI842Aw05C1z2ctA`)p.push(i.charCodeAt());var perm=new Array(512),gradP=new Array(512);function fade(t){return t*t*t*(t*(6*t-15)+10)}function lerp(t,e,r){return(1-r)*t+r*e}module.seed=function(t){t>0&&t<1&&(t*=65536),(t=Math.floor(t))<256&&(t|=t<<8);for(var e=0;e<256;e++){var r;r=1&e?p[e]^255&t:p[e]^t>>8&255,perm[e]=perm[e+256]=r,gradP[e]=gradP[e+256]=grad3[r%12]}},module.seed(0),module.perlin2=function(t,e){var r=Math.floor(t),a=Math.floor(e);t-=r,e-=a;var i=gradP[(r&=255)+perm[a&=255]].dot2(t,e),s=gradP[r+perm[a+1]].dot2(t,e-1),o=gradP[r+1+perm[a]].dot2(t-1,e),n=gradP[r+1+perm[a+1]].dot2(t-1,e-1),l=fade(t);return lerp(lerp(i,o,l),lerp(s,n,l),fade(e))};var letters={A:[[1,1,1],[1,,1],[1,,1],[1,1,1],[1,,1]],B:[[1,1],[1,,1],[1,1,1],[1,,1],[1,1]],C:[[1,1,1],[1],[1],[1],[1,1,1]],D:[[1,1],[1,,1],[1,,1],[1,,1],[1,1]],E:[[1,1,1],[1],[1,1,1],[1],[1,1,1]],F:[[1,1,1],[1],[1,1],[1],[1]],G:[[,1,1],[1],[1,,1,1],[1,,,1],[,1,1]],H:[[1,,1],[1,,1],[1,1,1],[1,,1],[1,,1]],I:[[1,1,1],[,1],[,1],[,1],[1,1,1]],J:[[1,1,1],[,,1],[,,1],[1,,1],[1,1,1]],K:[[1,,,1],[1,,1],[1,1],[1,,1],[1,,,1]],L:[[1],[1],[1],[1],[1,1,1]],M:[[1,1,1,1,1],[1,,1,,1],[1,,1,,1],[1,,,,1],[1,,,,1]],N:[[1,,,1],[1,1,,1],[1,,1,1],[1,,,1],[1,,,1]],O:[[1,1,1],[1,,1],[1,,1],[1,,1],[1,1,1]],P:[[1,1,1],[1,,1],[1,1,1],[1],[1]],Q:[[0,1,1],[1,,,1],[1,,,1],[1,,1,1],[1,1,1,1]],R:[[1,1,1],[1,,1],[1,,1],[1,1],[1,,1]],S:[[1,1,1],[1],[1,1,1],[,,1],[1,1,1]],T:[[1,1,1],[,1],[,1],[,1],[,1]],U:[[1,,1],[1,,1],[1,,1],[1,,1],[1,1,1]],V:[[1,,,,1],[1,,,,1],[,1,,1],[,1,,1],[,,1]],W:[[1,,,,1],[1,,,,1],[1,,,,1],[1,,1,,1],[1,1,1,1,1]],X:[[1,,,,1],[,1,,1],[,,1],[,1,,1],[1,,,,1]],Y:[[1,,1],[1,,1],[,1],[,1],[,1]],Z:[[1,1,1,1,1],[,,,1],[,,1],[,1],[1,1,1,1,1]],0:[[1,1,1],[1,,1],[1,,1],[1,,1],[1,1,1]],1:[[,1],[,1],[,1],[,1],[,1]],2:[[1,1,1],[0,0,1],[1,1,1],[1,0,0],[1,1,1]],3:[[1,1,1],[0,0,1],[1,1,1],[0,0,1],[1,1,1]],4:[[1,0,1],[1,0,1],[1,1,1],[0,0,1],[0,0,1]],5:[[1,1,1],[1,0,0],[1,1,1],[0,0,1],[1,1,1]],6:[[1,1,1],[1,0,0],[1,1,1],[1,0,1],[1,1,1]],7:[[1,1,1],[0,0,1],[0,0,1],[0,0,1],[0,0,1]],8:[[1,1,1],[1,0,1],[1,1,1],[1,0,1],[1,1,1]],9:[[1,1,1],[1,0,1],[1,1,1],[0,0,1],[1,1,1]],":":[[,,],[,1],[,,],[,1],[,,]],"/":[[0,0,1],[0,1,0],[0,1,0],[0,1,0],[1,0,0]]," ":[[,,],[,,],[,,],[,,],[,,]]};function getNeededText(t){var e=[];string=t.toUpperCase();for(var r=0;r<string.length;r++){var a=letters[string.charAt(r)];a&&e.push(a)}return e}function getTextSize(t,e){var r=getNeededText(t),a=0;for(let t=0;t<r.length;t++)a+=r[0].length*e;return a}function drawText(t,e,r,a,i){var s=getNeededText(t);ctx.fillStyle=i,console.log("Drawing "+t+", text: "+s);var o=0;for(let t=0;t<s.length;t++){var n=s[t],l=0,c=0;for(let t=0;t<n.length;t++){var h=n[t];for(let t=0;t<h.length;t++)h[t]&&ctx.fillRect(t*a+o+e,l+r,a,a);c=Math.max(c,h.length*a),l+=a}o+=a+c}return o}function srandom(){var t=1e4*Math.sin(seed++);return t-Math.floor(t)}function planetAtTime(t,e){var r=planets[t];if(0==t)return{x:0,y:0};if(0==r.center)return orbit(0,0,planets[r.center].mass,r.mass,r.orbitRadius,e+r.orbitOffset);var a=planetAtTime(r.center,e);return orbit(a.x,a.y,planets[r.center].mass,r.mass,r.orbitRadius,e+r.orbitOffset)}function orbit(t,e,r,a,i,s){var o=orbitSpeed(r,a,i)/i;return{x:Math.cos(s*o)*i+t,y:Math.sin(s*o)*i+e}}function orbitSpeed(t,e,r){var a=G()*(t+e);return Math.sqrt(a/r)}function orbitVelocityLow(t,e,r,a,i,s){var o=orbit(t,e,r,a,i,s),n=orbit(t,e,r,a,i,s+.01),l=normalize(n.x-o.x,n.y-o.y),c=orbitSpeed(r,a,i);return l.x*=c,l.y*=c,l}function orbitVelocity(t,e,r,a,i){if(0==t)return 0==r?{x:0,y:0}:orbitVelocityLow(0,0,planets[0].mass,e,r,a+i);var s=planets[t],o=orbitVelocityLow(planets[s.center].x,planets[s.center].y,planets[s.center].mass,s.mass,s.orbitRadius,a+s.orbitOffset),n=orbitVelocity(s.center,e,0,a,i),l={x:o.x+n.x,y:o.y+n.y};if(0==r)return l;var c=orbitVelocityLow(s.x,s.y,s.mass,e,r,a+i);return{x:l.x+c.x,y:l.y+c.y}}function gravity(t,e){var r={x:0,y:0};if(-1===e)for(var a=0;a<planets.length;a++){var i=gravityFrom(t,(s=planets[a]).x,s.y,planets[a].mass);r.x+=i.x,r.y+=i.y}else for(a=0;a<planets.length;a++){var s;i=gravityFrom(t,(s=planetAtTime(a,e)).x,s.y,planets[a].mass);r.x+=i.x,r.y+=i.y}return r}function collidesWithPlanet(t,e){for(var r=0;r<planets.length;r++){var a=planetAtTime(r,e);if(distance(t.x,t.y,a.x,a.y)<=1.02*planets[r].radius){var i={x:t.x-a.x,y:t.y-a.y},s=normalize(i.x,i.y);return{planet:r,sx:s.x*planets[r].radius*1.02,sy:s.y*planets[r].radius*1.02,nx:s.x,ny:s.y}}}return null}function collidesWithCity(t,e){var r=collidesWithPlanet(t,e);if(null!=r){var a=planets[r.planet];if(null!=a.cities)for(var i=0;i<a.cities.length;i++){var s=a.cities[i],o=s.x*a.radius*.98+a.x,n=s.y*a.radius*.98+a.y;if(distance(o,n,t.x,t.y)<=2*s.size)return{city:s,idx:i,planet:r.planet,rx:o,ry:n}}}return null}function collidesWithAny(t,e){return{city:collidesWithCity(t,e),planet:collidesWithPlanet(t,e)}}function gravityFrom(t,e,r,a){var i=distance2(t.x,t.y,e,r),s=normalize(e-t.x,r-t.y),o=G()*(a/i);return{x:s.x*o,y:s.y*o}}function G(){return 2.5}function putShipInOrbit(t,e,r,a,i){var s=orbit(planets[e].x,planets[e].y,planets[e].mass,shipMass,r,time+a),o=orbitVelocity(e,shipMass,r,time,a);t.x=s.x,t.y=s.y,t.speed.x=o.x,t.speed.y=o.y}function randomShip(t){var e=rrg(0,100),r=rrg(0,5);return createShip(e<=50?0:e<=90?1:2,srandom(),t,r)}function randomColor(t,e){var r,a,i;if(0==t){var s=rrg(128,180);r=s,a=s,i=s}else 1==t?rrg(0,100)>=50?(r=rrg(50,170),a=rrg(90,200),i=rrg(80,170)):(r=rrg(100,200),a=rrg(80,170),i=rrg(50,100)):2==t?(r=rrg(100,250),a=rrg(40,100),i=rrg(50,100)):3==t?(r=rrg(50,200),a=rrg(50,200),i=rrg(50,200)):(r=rrg(0,255),a=rrg(0,255),i=rrg(0,255));return"rgb("+r*e+","+a*e+","+i*e+")"}function getPlanetSpeed(t,e){return t==planets[0]?{x:0,y:0}:orbitVelocity(t.center,t.mass,t.orbitRadius,e,t.orbitOffset)}function showEvent(t,e){eventStr=t,eventTimer=e}function sideColor(t){var e,r,a;return 0==t?(r=(e=rrg(80,160))*rrg(80,100)*.01,a=e*rrg(100,130)*.01):1==t?(r=(e=rrg(120,210))*rrg(70,80)*.01,a=e*rrg(40,50)*.01,e*=.01*rrg(100,150),r*=.01*rrg(60,90),a*=.01*rrg(60,90)):(r=e=rrg(80,110),a=e),"rgb("+e+","+r+","+a+")"}function makeColorAlpha(t){var e=t;return e=(e=e.splice(0,4,"")).splice(t.length-5,2,"")}function rrg(t,e){return Math.floor(t+srandom()*(e+1-t))}function imageDataToImage(t){var e=document.createElement("canvas"),r=e.getContext("2d");e.width=t.width,e.height=t.height,r.putImageData(t,0,0);var a=new Image;return a.src=e.toDataURL(),e.innerHTML="",a}function drawBright(t,e,r,a){var i=ctx.globalCompositeOperation;ctx.globalCompositeOperation="lighter",ctx.translate(t,e),ctx.scale(r,r),ctx.drawImage(brightImage,-brightData.width/2,-brightData.height/2),ctx.scale(1/r,1/r),ctx.translate(-t,-e),ctx.globalCompositeOperation=i}function doCameraTransform(){ctx.translate(canvas.width/2,canvas.height/2),lockCamera&&ctx.rotate(-ships[0].rot-Math.PI),ctx.scale(camera.zoom,camera.zoom),ctx.translate(-camera.x,-camera.y)}function sanitizeAngle(t){var e=t;return Math.abs(e)>=2*Math.PI&&(e%=2*Math.PI),e<=0&&(e=2*Math.PI+e),e}function angleDiff(t,e){var r=t-e;return r>Math.PI&&(r=-2*Math.PI+r),r}function normalize(t,e){var r=Math.sqrt(t*t+e*e);return{x:t/r,y:e/r}}function distance2(t,e,r,a){let i=t-r,s=e-a;return i*i+s*s}function distance(t,e,r,a){return Math.sqrt(distance2(t,e,r,a))}function rotate(t,e,r){var a=Math.atan2(e,t),i=Math.sqrt(t*t+e*e);return a+=r,{x:i*Math.cos(a),y:i*Math.sin(a)}}function shipTaskLookAt(t,e){t.ai.task={target:e,type:0}}function shipBehaviourLand(t,e){t.frame=e,t.ai.beh={type:0,motorTimer:0}}function shipBehaviourOrbit(t,e,r){t.frame=e,t.ai.beh={type:1,radius:r,injection:!1,maintain:!1,predictTimer:4,palt:0}}function aiLookAt(t,e,r){var a=angleDiff(sanitizeAngle(t.rot),r.target),i=angleDiff(sanitizeAngle(t.rot+t.angspeed*e),r.target),s=Math.abs(i)-Math.abs(a),o=1;return Math.abs(a)<=1&&(o=Math.max(1*Math.abs(a)*Math.abs(a),.6)),s<0?Math.abs(t.angspeed)>=Math.min(2*Math.abs(a),1)&&(Math.abs(a)<=Math.PI/4?t.thrust.rot=-Math.sign(a)*o*.1:t.thrust.rot=0):t.thrust.rot=-Math.sign(a)*o*1.4,Math.abs(a)<=.01&&Math.abs(t.angspeed)<=.1&&(t.angspeed=0,t.rot=r.target,t.thrust.rot=0),Math.abs(a)}function isEnemy(t,e){return 0==t?1==e:e!=t}function updateShipAI(t,e){var r=1e3;if(t.ai.targetTimer-=e,t.ai.targetTimer<=0&&(!function(){1==t.side&&rrg(0,1e3)>=700&&(t.ai.target=0),t.ai.target=-1;for(var e=0;e<ships.length;e++)isEnemy(t.side,ships[e].side)&&rrg(0,1e3)>=600&&(found=!0,t.ai.target=e)}(),-1==t.ai.target?t.ai.targetTimer=rrg(1,5):t.ai.targetTimer=rrg(3,16)),-1!=t.ai.target?t.firing=!0:t.firing=!1,null!=t.ai.task&&0==t.ai.task.type&&(r=aiLookAt(t,e,t.ai.task)),null!=t.ai.beh){var a=t.ai.beh;if(0==a.type){shipTaskLookAt(t,getProgradeAngle(t)+Math.PI);var i=t.thrust.fw;r<=.02&&getFrameSpeed(t)>=10&&a.motorTimer<=0?t.thrust.fw=1:(t.thrust.fw=0,getAltitudeGround(t)<=200&&0!=i&&(a.motorTimer=1)),a.motorTimer-=e,t.landed&&(t.ai.beh=null,t.ai.task=null,t.thrust.fw=0)}else if(1==a.type){var s=getAltitudeGround(t),o=getAltitude(t),n=planets[t.frame];a.maintain?(a.predictTimer-=e,a.predictTimer<=0&&(predictShip(t),a.predictTimer=4),shipTaskLookAt(t,getProgradeAngle(t)),s<10&&shipBehaviourOrbit(t,t.frame,1.4*a.radius),t.landed&&(t.frame=t.coll.planet,shipBehaviourOrbit(t,t.coll.planet,1.4*a.radius)),r<.1?s<.8*a.radius?t.thrust.side=-.05:s>1.2*a.radius?t.thrust.side=.05:(t.thrust.side=0,t.thrust.fw=0):(t.thrust.fw=0,t.thrust.side=0)):a.injection?(shipTaskLookAt(t,a.angle),t.thrust.fw=1,getFrameSpeed(t)>=orbitSpeed(planets[t.frame].mass,.001,o)&&(a.radius=s,t.thrust.fw=0,a.maintain=!0)):s<=a.radius/2?(shipTaskLookAt(t,Math.atan2(t.y-n.y,t.x-n.x)-Math.PI/2),t.thrust.fw=1):s>=a.palt?(shipTaskLookAt(t,Math.atan2(t.y-n.y,t.x-n.x)),t.thrust.fw=0):(null==a.angle&&(a.angle=Math.atan2(t.y-n.y,t.x-n.x)),shipTaskLookAt(t,a.angle),t.thrust.fw=0,(r=aiLookAt(t,e,t.ai.task))<=.1&&(a.injection=!0)),a.palt=s}}}function shoot(t,e,r,a,i,s,o){bullets.push({x:t,y:e,vx:r,vy:a,side:i,size:s,timer:o,color:sideColor(i)})}function updateBullet(t,e){t.x+=t.vx*e,t.y+=t.vy*e;var r=gravity(t,time);t.vx+=r.x*e,t.vy+=r.y*e;var a=t.size,i=collidesWithAny(t,time);i.ship=null;for(var s=0;s<ships.length;s++)if(isEnemy(t.side,ships[s].side)){var o=5;1==ships[s].type?o=14:2==ships[s].type&&(o=24),distance(t.x,t.y,ships[s].x,ships[s].y)<=o&&(i.ship=ships[s])}if(null!=i.planet){var n=i.planet,l=orbitVelocity((c=planets[n.planet]).center,c.mass,c.orbitRadius,time,c.orbitOffset);if(explode(t.x,t.y,l.x,l.y,17*t.size,2.4,.4,!0,!1),null!=i.city&&2==t.side){n=i.city;var c,h=(c=planets[n.planet]).cities[n.idx];h.health-=a,c.warTime<=0&&(c.firstWave=!0),c.warTime=30,h.health<=0&&(explode(n.rx,n.ry,l.x,l.y,7*h.size,1.5,1,!0,!1),c.cities.splice(n.idx,1),c.maxForces=getMaxForces(c))}return!0}return null!=i.ship?(explode(t.x,t.y,i.ship.speed.x,i.ship.speed.y,17*t.size,2.4,.4,!0,!1),i.ship.health-=a,!0):(t.timer-=e,t.timer<=0)}function drawBullet(t){ctx.strokeStyle="rgb(255, 200, 200)",ctx.strokeStyle=t.color,ctx.lineWidth=t.size,ctx.beginPath(),ctx.moveTo(t.x,t.y);var e=normalize(t.vx-ships[0].speed.x,t.vy-ships[0].speed.y);ctx.lineTo(t.x-e.x*t.size*5,t.y-e.y*t.size*5),ctx.stroke()}function explode(t,e,r,a,i,s,o,n,l,c=.5){var h={x:t,y:e,vx:r,vy:a,time:0,size:i,speed:s,shock:o,bright:n};explosions.push(h),explosionSound(i/100,t,e,l,c)}function burn(t,e,r,a,i,s){var o={x:t,y:e,vx:r,vy:a,time:0,size:i,speed:s};fire.push(o)}function drawFire(t){ctx.beginPath();var e=Math.pow(t.time,2),r=70*e+255*(1-t.time),a=70*e+200*(1-t.time),i=70*e+200*(1-t.time);ctx.fillStyle="rgba("+r+", "+a+", "+i+", "+.5*t.time+")";var s=Math.sqrt(t.time)*t.size;ctx.arc(t.x,t.y,s,0,2*Math.PI),ctx.fill()}function drawExplosion(t){t.time<=.1*t.speed&&1==t.bright&&drawBright(t.x,t.y,t.size/256,128),0!=t.shock&&(ctx.fillStyle="rgba(255, 255, 255, "+(1-Math.pow(t.time,1/3.5))+")",ctx.beginPath(),ctx.arc(t.x,t.y,Math.pow(4*t.time,.4)*t.size*t.shock,0,2*Math.PI),ctx.fill())}function updateExplosion(t,e){return t.time+=e*t.speed,t.x+=t.vx*e,t.y+=t.vy*e,t.time>=1}function updateFire(t,e){return t.time+=e*t.speed,t.x+=t.vx*e,t.y+=t.vy*e,t.time>=1}String.prototype.splice||(String.prototype.splice=function(t,e,r){return this.slice(0,t)+r+this.slice(t+Math.abs(e))}),zzfx_v=.5,zzfx_x=new AudioContext,zzfx=(t,e,r,a=1,i=.1,s=0,o=0,n=0,l=0)=>{let c=44100,h=Math.PI;r*=2*h/c,r*=1+e*(2*Math.random()-1),s*=1e3*h/c**2,i*=0|(a=0<a?c*(10<a?10:a)|0:1),n*=2*h/c,l*=h,e=[];for(var x=0,d=0,p=0;p<a;++p)e[p]=t*zzfx_v*Math.cos(x*r*Math.cos(d*n+l))*(p<i?p/i:1-(p-i)/(a-i)),x+=1+o*(2*Math.random()-1),d+=1+o*(2*Math.random()-1),r+=s;return t=zzfx_x.createBuffer(1,a,c),r=zzfx_x.createBufferSource(),t.getChannelData(0).set(e),r.buffer=t,r.connect(zzfx_x.destination),r.start(),r};var rockNames=["Lygkos","Lithos","Guamedo","Eadu","Anoth","Dikti","Big Iron","Impetu"],terraNames=["Delphi","Trapani","Erytrae","Gaia","Boston","Jericho","Nile","New London"],gasNames=["Bespin","Nuvo","New Jupiter","Vol","Lightbulb","Big Boy"],desertNames=["Rhodes","New Jairo","Jakku","Savareen","Arrakis","New Sahara"];seed=75774,noise.seed(seed);let previousTime=0;var time=0,canvas=document.getElementById("canvas");canvas.width=.8*window.innerWidth,canvas.height=.8*window.innerHeight;var starFieldImage,brightImage,sun,ctx=canvas.getContext("2d"),starFieldSize=Math.floor(Math.max(canvas.width,canvas.height)*(1+Math.sqrt(2))),starFieldData=ctx.createImageData(starFieldSize,starFieldSize),brightSize=768,brightData=ctx.createImageData(brightSize,brightSize),planets=Array(),planetCount=rrg(9,14),explosions=Array(),bullets=Array(),fire=Array(),ships=Array(),rings=Array(),camera={x:0,y:0,zoom:.5},aimPoint={x:0,y:0},mousePos={x:0,y:0},thrustSpeed=1,mapMode=0,mode=0,shipMass=.001,timestep=1,dtval=0,lockCamera=!1,timestepVals=[0,1,2,4,10,25,50,100],timestepVal=1,eventTimer=0,eventStr="";generateStarfield(),generateBright(),generate(),sun.name="The Sun";for(var terra=1,i=0;i<planets.length;i++)if(1==planets[i].type){terra=i,planets[i].name="New Earth",planets[i].cities=[],createCities(planets[i],.5,0);break}ships.push(createShip(1,2400,2,5)),putShipInOrbit(ships[0],terra,800,0,!0),ships[0].predict=new Array,ships[0].frame=terra;var chooseFrame=!1,chooseFocus=!1,predictTimer=0,camFocus=-1,tooltipTime=0,tooltipFocus=-1,tooltipEnabled=!1;function update(){for(var t=dtval,e=0;e<timestep;e++){t=dtval;for(var r=1;r<planets.length;r++){var a=planets[r];updateWar(a,t);var i=orbit(planets[a.center].x,planets[a.center].y,planets[a.center].mass,a.mass,a.orbitRadius,time+a.orbitOffset);a.x=i.x,a.y=i.y}if(dtval>0){for(r=0;r<ships.length;r++){var s=ships[r];null!=s&&(r>0?(updateShipAI(s,t),-1==s.ai.target||s.destroyed||aimShipGuns(s,ships[s.ai.target],t)):aimShipGuns(s,aimPoint,t),simulateShip(s,t)&&0!=r&&(explode(s.x,s.y,s.speed.x,s.speed.y,rrg(50,200),1,1,!0,!1),ships.splice(r,1),r--))}for(r=0;r<explosions.length;r++)updateExplosion(explosions[r],t)&&(explosions.splice(r,1),r--);for(r=0;r<fire.length;r++)updateFire(fire[r],t)&&(fire.splice(r,1),r--);for(r=0;r<bullets.length;r++)updateBullet(bullets[r],t)&&(bullets.splice(r,1),r--);time+=t}}if(dtval>0){if((aimPoint={x:mousePos.x,y:mousePos.y}).x-=canvas.width/2,aimPoint.y-=canvas.height/2,lockCamera){var o=ships[0].rot+Math.PI,n=rotate(aimPoint.x,aimPoint.y,o);aimPoint.x=n.x,aimPoint.y=n.y}aimPoint.x*=1/camera.zoom,aimPoint.y*=1/camera.zoom,aimPoint.x+=camera.x,aimPoint.y+=camera.y,-1==camFocus?(camera.x=ships[0].x,camera.y=ships[0].y):(camera.x=planets[camFocus].x,camera.y=planets[camFocus].y);var l=collidesWithPlanet(aimPoint,time);if(chooseFrame&&null!=l&&ships[0].frame!=l.planet&&(ships[0].frame=l.planet,showEvent("Changed reference frame to "+planets[l.planet].name,2)),chooseFocus){var c=camFocus;distance(aimPoint.x,aimPoint.y,ships[0].x,ships[0].y)<100?camFocus=-1:null!=l&&(camFocus=l.planet),c!=camFocus&&showEvent(-1==camFocus?"Focusing on ship":"Focusing on "+planets[camFocus].name,2)}null==l?(tooltipTime=0,tooltipFocus=-1):l.planet!=tooltipFocus&&(tooltipTime=0,tooltipFocus=l.planet),predictTimer<0||0!=ships[0].thrust.fw||0!=ships[0].thrust.side?(predictShip(ships[0],t),predictTimer=.5):predictTimer-=t,zoomSpeed-=zoomSpeed*dtval*3,Math.abs(zoomSpeed)<=.1&&(zoomSpeed=0),camera.zoom+=camera.zoom*zoomSpeed*dtval*.8,mapMode=camera.zoom<=.16?Math.max(Math.min(.04/camera.zoom,1),0):0,tooltipTime+=t,eventTimer-=t}}function render(){ctx.setTransform(1,0,0,1,0,0),ctx.translate(canvas.width/2,canvas.height/2),lockCamera&&ctx.rotate(-ships[0].rot-Math.PI),ctx.translate(-starFieldSize/2-canvas.height/2,-starFieldSize/2-canvas.width/2),ctx.drawImage(starFieldImage,0,0),ctx.setTransform(1,0,0,1,0,0),doCameraTransform();for(var t=0;t<rings.length;t++)drawRing(rings[t],time);drawBright(0,0,125);for(t=1;t<planets.length;t++)drawPlanet(planets[t]);for(t=0;t<ships.length;t++)drawShip(ships[t]);for(t=1;t<planets.length;t++)drawPlanetOver(planets[t]);for(t=1;t<planets.length;t++)drawPlanetShadow(planets[t]);for(t=0;t<ships.length;t++)drawShipExhaust(ships[t]);for(t=0;t<explosions.length;t++)drawExplosion(explosions[t]);for(t=0;t<bullets.length;t++)drawBullet(bullets[t]);for(t=0;t<fire.length;t++)drawFire(fire[t]);if(drawStar(sun),mapMode>0){ctx.globalAlpha=mapMode;for(t=1;t<planets.length;t++)drawPlanetMap(planets[t]);drawShipMap(ships[0]),ctx.globalAlpha=1}if(drawShipHud(ships[0]),tooltipFocus>0&&tooltipEnabled&&drawTooltip(planets[tooltipFocus],aimPoint.x,aimPoint.y),ctx.setTransform(1,0,0,1,0,0),eventTimer>=0){ctx.globalAlpha=eventTimer;var e=getTextSize(eventStr,2);drawText(eventStr,canvas.width/2-e/2,20,2,"white"),ctx.globalAlpha=1}if(0==timestep){e=getTextSize("Paused",2);drawText("Paused",canvas.width/2-e/2,50,2,"white")}drawGeneralHUD()}const loop=t=>{const e=t-previousTime;previousTime=t,dtval=e/1e3,update(),render(),window.requestAnimationFrame(loop)};function onkey(t){var e="keyup"==t.type,r=t.code,a=ships[0].thrust,i=1;e&&(i=0),"KeyT"==r&&(tooltipEnabled=!e),0==mode&&("KeyW"==r?a.fw=i:"KeyS"==r?a.fw=-i:"KeyA"==r?a.rot=-i:"KeyD"==r?a.rot=i:"KeyQ"==r?a.side=-i:"KeyE"==r&&(a.side=i)),e||("KeyL"==r&&showEvent((lockCamera=!lockCamera)?"Camera aligned to ship":"Camera aligned to space",2),"KeyU"==r&&shipBehaviourLand(ships[0],ships[0].frame),"KeyI"==r&&shipBehaviourOrbit(ships[0],ships[0].frame,400),"KeyP"==r&&(++timestepVal>timestepVals.length-1?timestepVal=timestepVals.length-1:showEvent((timestep=timestepVals[timestepVal]).toString()+"x Timewarp",2)),"KeyO"==r&&(--timestepVal<0?timestepVal=0:showEvent((timestep=timestepVals[timestepVal]).toString()+"x Timewarp",2)))}window.requestAnimationFrame(t=>{previousTime=t,loop(t)});var zoomSpeed=0;function onwheel(t){zoomSpeed-=Math.sign(t.deltaY)}function onmouse(t){var e="mousedown"==t.type;1==t.which?ships[0].firing=e:2==t.which?chooseFocus=e:3==t.which&&(chooseFrame=e)}function mousemove(t){var e=getMousePos(canvas,t);mousePos.x=e.x,mousePos.y=e.y}function getMousePos(t,e){var r=t.getBoundingClientRect();return{x:e.clientX-r.left,y:e.clientY-r.top}}function drawTooltip(t,e,r){lockCamera&&(ctx.translate(e,r),ctx.rotate(ships[0].rot+Math.PI),ctx.translate(-e,-r));var a=300;ctx.fillStyle="rgba(0, 0, 0, 0.8)",ctx.strokeStyle="rgb(255, 255, 255)",ctx.beginPath(),ctx.rect(e,r,a/camera.zoom,350/camera.zoom),ctx.fill(),ctx.stroke();var i=8/camera.zoom,s="rgb(255, 220, 200)",o="rgb(255, 255, 255)",n=0,l=0;n+=drawText("Name: ",e+i,r+i,2/camera.zoom,s),n+=drawText(t.name,e+i+n,r+i,2/camera.zoom,o),n=0,l+=16/camera.zoom;var c=0,h=0;if(null!=t.cities)for(var x=0;x<t.cities.length;x++)0==t.cities[x].side?c++:h++;if(0==c&&0==h)n+=drawText("Planet is uninhabited",e+i,r+i+l,2/camera.zoom,s),n=0,l+=16/camera.zoom,n+=drawText("Ore: ",e+i,r+i+l,2/camera.zoom,s),n+=drawText(t.ore.toString(),e+i+n,r+i+l,2/camera.zoom,o),n=0,l+=16/camera.zoom,n+=drawText("Fuel: ",e+i,r+i+l,2/camera.zoom,s),n+=drawText(t.fuel.toString(),e+i+n,r+i+l,2/camera.zoom,o);else{function d(t){for(var s=0;s<t.length;s++){var o=.15/camera.zoom;ctx.translate(e+n,r+l),ctx.scale(o,o),drawShipLow(t[s]),ctx.scale(1/o,1/o),ctx.translate(-e-n,-r-l),(n+=128*o)>=a/camera.zoom-i&&(n=2*i,l+=350*o)}}n+=drawText("Cities: ",e+i,r+i+l,2/camera.zoom,s),n+=drawText(c.toString(),e+i+n,r+i+l,2/camera.zoom,"rgb(0, 255, 0)"),n+=drawText(" / ",e+i+n,r+i+l,2/camera.zoom,o),n+=drawText(h.toString(),e+i+n,r+i+l,2/camera.zoom,"rgb(255, 0, 0)"),n=0,l+=16/camera.zoom,n+=drawText("Human Ships: ",e+i,r+i+l,2/camera.zoom,s),n+=drawText(t.humanForces.length.toString(),e+i+n,r+i+l,2/camera.zoom,o),n+=drawText(" / ",e+i+n,r+i+l,2/camera.zoom,o),n+=drawText(t.maxForces.human.toString(),e+i+n,r+i+l,2/camera.zoom,o),n=2*i,l+=32/camera.zoom,d(t.humanForces),l+=64/camera.zoom,n=0,n+=drawText("AI Ships: ",e+i,r+i+l,2/camera.zoom,s),n+=drawText(t.aiForces.length.toString(),e+i+n,r+i+l,2/camera.zoom,o),n+=drawText(" / ",e+i+n,r+i+l,2/camera.zoom,o),n+=drawText(t.maxForces.ai.toString(),e+i+n,r+i+l,2/camera.zoom,o),n=2*i,l+=32/camera.zoom,d(t.aiForces)}ctx.setTransform(1,0,0,1,0,0),doCameraTransform()}function drawShipHud(t){if(ctx.strokeStyle="rgb(204,168,255)",ctx.lineWidth=Math.max(1/camera.zoom,1),camera.zoom<=1.5&&camera.zoom>=1&&(ctx.globalAlpha=1-2*(camera.zoom-1)),camera.zoom<=1.5&&!t.landed&&null!=t.predict){ctx.beginPath();for(var e=planets[t.frame],r=0;r<t.predict.length;r++){var a=planetAtTime(t.frame,t.predict[r].time),i=t.predict[r].x-a.x+e.x,s=t.predict[r].y-a.y+e.y;0==r?ctx.moveTo(i,s):ctx.lineTo(i,s)}ctx.stroke()}ctx.globalAlpha=1;var o=Math.max(32/camera.zoom,32);ctx.strokeStyle="rgb(128, 128, 128)",ctx.lineWidth=Math.max(2/camera.zoom,2),ctx.beginPath(),ctx.arc(t.x,t.y,o,0,2*Math.PI),ctx.stroke(),ctx.strokeStyle="rgb(255, 255, 255)";var n=Math.cos(t.rot+Math.PI/2),l=Math.sin(t.rot+Math.PI/2);ctx.beginPath(),ctx.moveTo(t.x+n*o*.5,t.y+l*o*.5),ctx.lineTo(t.x+n*o,t.y+l*o),ctx.stroke();var c=getProgradeVector(t),h=-c.x,x=-c.y,d=-c.y,p=c.x,m=c.y,u=-c.x,g=normalize(t.acc.x,t.acc.y);ctx.strokeStyle="rgb(255,214,117)",ctx.beginPath(),ctx.moveTo(t.x+c.x*o*1,t.y+c.y*o*1),ctx.lineTo(t.x+c.x*o*1.5,t.y+c.y*o*1.5),ctx.stroke(),ctx.beginPath(),ctx.moveTo(t.x+h*o*1.25,t.y+x*o*1.25),ctx.lineTo(t.x+h*o*1.5,t.y+x*o*1.5),ctx.stroke(),ctx.strokeStyle="rgb(87,188,255)",ctx.beginPath(),ctx.moveTo(t.x+d*o*1,t.y+p*o*1),ctx.lineTo(t.x+d*o*1.5,t.y+p*o*1.5),ctx.stroke(),ctx.beginPath(),ctx.moveTo(t.x+m*o*1.25,t.y+u*o*1.25),ctx.lineTo(t.x+m*o*1.5,t.y+u*o*1.5),ctx.stroke(),ctx.fillStyle="rgb(187,128,255)",ctx.beginPath(),ctx.arc(t.x+g.x*o,t.y+g.y*o,o/15,0,2*Math.PI),ctx.fill()}function drawGeneralHUD(){}function generateBright(){for(var t=0;t<brightSize;t++)for(var e=0;e<brightSize;e++){var r=t*brightSize+e,a=e-brightSize/2,i=t-brightSize/2,s=brightSize/((a*a+i*i)/6),o=s,n=Math.atan2(i,a);o+=.6*noise.perlin2(15*n,0),o-=1-Math.pow(s,.03);var l=Math.max(1-(s-1)*(s-1),0),c=Math.max(1-(s-1.2)*(s-1.2),0),h=Math.max(1-(s-1.4)*(s-1.4),0),x=noise.perlin2(8*n,1)*l+l,d=noise.perlin2(16*n,7)*c+c,p=noise.perlin2(32*n,15)*h+h;brightData.data[4*r+0]=200*o+128*x,brightData.data[4*r+1]=160*o+118*d,brightData.data[4*r+2]=128*o+98*p,brightData.data[4*r+3]=255*o}brightImage=imageDataToImage(brightData)}function generateStarfield(){for(var t=0;t<starFieldSize;t++)for(var e=0;e<starFieldSize;e++){var r=t*starFieldSize+e,a=0,i=0,s=0,o=noise.perlin2(.001*e,.001*t),n=noise.perlin2(.01*e+o,.01*t+o),l=noise.perlin2(.05*e,.05*t),c=noise.perlin2(.01*e+5,.01*t+5);if(i=.7*(a=255*(n+l+o))+60*c,s=.5*a+128*c,rrg(0,1e4)>=9995)a=255,i=255,s=255;else{a*=.25,i*=.25,s*=.25}starFieldData.data[4*r+0]=a,starFieldData.data[4*r+1]=i,starFieldData.data[4*r+2]=s,starFieldData.data[4*r+3]=255}starFieldImage=imageDataToImage(starFieldData)}function generatePlanet(t,e,r,a){var i,s;if(0==t){var o=rrg(250,850)*e;i=createPlanet(rrg(25,60),rrg(140,150),o,0,randomColor(0,1),randomColor(0,.5),randomColor(0,1),"0, 0, 0",rrg(0,1e4),64),s=rockNames[r%rockNames.length],rrg(0,1e3)>=700?createCities(i,.01*rrg(-100,40),srandom()):(i.ore=rrg(100,2*o),i.fuel=rrg(50,100))}else if(1==t){o=rrg(300,600)*e;i=createPlanet(rrg(25,30),rrg(90,160),o,o+rrg(120,170),randomColor(1,1),randomColor(1,.5),randomColor(1,1),"120, 120, 255",rrg(0,1e4),64),s=terraNames[r%terraNames.length],createCities(i,.01*rrg(-50,100),srandom())}else if(2==t){o=rrg(350,900)*e;i=createPlanet(rrg(15,25),rrg(80,120),o,o+rrg(120,170),randomColor(2,1),randomColor(2,.5),randomColor(2,1),"255, 120, 120",rrg(0,1e4),64),s=desertNames[r%desertNames.length],rrg(0,1e3)>=200?createCities(i,.01*rrg(-100,60),srandom()):(i.ore=rrg(50,2*o),i.fuel=rrg(200,500))}else if(3==t){o=rrg(700,1800)*e;var n=randomColor(3,1);i=createGasPlanet(o,o+rrg(50,300),makeColorAlpha(n),n,randomColor(3,1)),s=gasNames[r%gasNames.length],i.ore=0,i.fuel=rrg(1e3,2e3)}else if(4==t){let t="AEIOUNGRJ";o=rrg(40,120)*e;i=createPlanet(rrg(25,60),rrg(140,150),o,0,randomColor(2,1),randomColor(2,.5),randomColor(2,1),"0, 0, 0",rrg(0,1e4),32),s=t[rrg(0,t.length-1)]+t[rrg(0,t.length-1)]+r,i.ore=rrg(100,4*o),i.fuel=rrg(10,100)}return i.mass=4*Math.PI*i.radius*i.radius,i.orbitColor=randomColor(-1,2),-1!=a&&(s=planets[a].name+" "+r),i.name=s,i}function generate(){(sun=createStar(0,0,5e3,"rgb(255, 240, 200)","White")).mass=5*Math.PI*sun.radius*sun.radius,sun.sun=!0,planets.push(sun);for(var t=0;t<planetCount;t++){var e=rrg(0,4),r=rrg(9e3,8e4);1==e&&(r<=4e4||r>=8e4)&&(e=2),(s=generatePlanet(e,1,t,-1)).orbitRadius=r,s.orbitOffset=rrg(-5e4,5e4),s.center=0,s.type=e,s.idx=planets.length,planets.push(s)}for(t=1;t<planetCount+1;t++){for(var a=rrg(0,planets[t].radius/300),i=0;i<a;i++){var s;3==(e=rrg(0,4))&&(e=0),(s=generatePlanet(e,.01*rrg(25,60),i+1,t)).radius>=.6*planets[t].radius&&(s.radius*=.5,s.atmoRadius*=.5);var o=planets[t].radius+5*s.radius,n=planets[t].orbitRadius/16e3;s.orbitRadius=rrg(o,o+planets[t].radius*n),s.orbitOffset=rrg(0,5e5),s.center=t,s.type=e,s.idx=planets.length,planets.push(s)}if(rrg(0,1e3)>=900&&planets[t].radius>=150){var l=rrg(1.5*planets[t].radius,8*planets[t].radius),c=createRing(t,l,l+.01*rrg(50,300)*planets[t].radius,3e-7*rrg(80,400));rings.push(c)}}update(0);var h=!1,x=!1,d=!1,p=!1,m=!1;for(t=1;t<planets.length;t++)if(1==planets[t].type&&(h=!0),2==planets[t].type&&(d=!0),3==planets[t].type&&(x=!0),4==planets[t].type&&(p=!0),t<planetCount)for(i=1;i<planetCount;i++){if(i!=t)distance(planets[t].x,planets[t].y,planets[i].x,planets[i].y)<=9e3&&(m=!0)}(0==h||0==x||0==d||0==p||rings.length<=1||m)&&(planets=[],seed+=rrg(1,5e3),generate())}function createPlanet(t,e,r,a,i,s,o,n,l,c){var h=Array(c),x=Array(c);noise.seed(l);for(var d=0;d<c;d++){var p=noise.perlin2(d/c*t*1,0)*e,m=noise.perlin2(d/c*t*2,5)*e*.5,u=noise.perlin2(d/c*t*4,8)*e*.25;h[d]=1.5*Math.max(p+m,0),x[d]=.2*(noise.perlin2(d/c*t,40)*e+u)}return{x:0,y:0,radius:r,atmoRadius:a,colorInner:i,colorOuter:s,colorDetail:o,colorAtmo:n,heights:h,bheights:x,isGasPlanet:!1,cities:[],ore:0,fuel:0}}function getMaxForces(t){for(var e=0,r=0,a=0;a<t.cities.length;a++)0==t.cities[a].side?e+=t.cities[a].size/20:r+=t.cities[a].size/20;return{human:e=Math.min(Math.floor(e),26),ai:r=Math.min(Math.floor(r),26)}}function createForces(t){var e=getMaxForces(t);t.humanForces=new Array,t.aiForces=new Array;for(var r=0;r<e.human/2+e.ai;r++)r<e.human/2?t.humanForces.push(randomShip(0)):t.aiForces.push(randomShip(1));t.maxForces=e,t.deployed=new Array,t.warTime=0,t.aiTime=0,t.humanTime=0}function createCities(t,e,r){noise.seed(r);for(var a=1/(t.radius/34),i=0;i<2*Math.PI;i+=a){var s=1.2*noise.perlin2(i,0);if(Math.abs(s)>=.2){s=Math.max(Math.min(s+e,1),-1);var o=Math.cos(i),n=Math.sin(i),l=Math.min(Math.max(.12*Math.abs(s)*t.radius,18),50);s=s>=0?0:1,t.cities.push({x:o,y:n,size:l,side:s,tone:rrg(80,200),health:l,mhealth:l})}}createForces(t)}function updateWar(t,e){if(null!=t.warTime)if(t.warTime-=e,t.warTime<=0)for(var r=0;r<t.deployed;r++);else{function a(e,r){for(var a=0;a<i;a++){if(e.length<=0)return;var s=rrg(0,e.length-1),o=e[s];e.splice(s,1);var n=normalize(rrg(0,1e3)-500,rrg(0,1e3)-500);n.x*=1.02*t.radius,n.y*=1.02*t.radius,o.x=t.x+n.x,o.y=t.y+n.y,o.rot=Math.atan2(n.y,n.x)-Math.PI/2,o.speed=getPlanetSpeed(t,time),o.frame=t.idx,shipBehaviourOrbit(o,t.idx,rrg(60,t.radius)),ships.push(o)}}if(t.firstWave||t.wave<=0){var i=rrg(1,2),s=rrg(.2*i,.8*i);a(t.aiForces),a(t.humanForces),console.log("Spawning "+i+" AIs, and "+s+" humans"),t.firstWave=!1}}}function createGasPlanet(t,e,r,a,i){return{x:0,y:0,radius:t,atmoRadius:e,colorAtmo:r,color0:a,color1:i,isGasPlanet:!0}}function drawAtmosphere(t,e,r,a,i){var s=ctx.createRadialGradient(t,e,r,t,e,a);s.addColorStop(0,"rgba("+i+",0.5)"),s.addColorStop(1,"rgb("+i+", 0)"),ctx.fillStyle=s,ctx.beginPath(),ctx.arc(t,e,a,0,2*Math.PI),ctx.fill()}function drawPlanetShadow(t){var e=t.x*t.x+t.y*t.y,r=Math.sqrt(e+t.radius*t.radius),a=Math.PI/2-Math.atan2(-t.y,-t.x),i=Math.acos(t.radius/r),s=a-i,o=a+i,n=1*t.radius;0!=t.atmoRadius&&(n=t.atmoRadius);var l=t.x+Math.sin(s)*n,c=t.y+Math.cos(s)*n,h=t.x+Math.sin(o)*n,x=t.y+Math.cos(o)*n,d=32*t.radius,p=Math.sqrt(l*l+c*c),m=Math.sqrt(h*h+x*x),u=Math.sqrt(e),g=l/p,y=c/p,f=h/m,v=x/m,M=ctx.createLinearGradient(t.x,t.y,t.x+t.x/u*d,t.y+t.y/u*d),b=.005+Math.max((t.atmoRadius-t.radius)/32e3,0);M.addColorStop(0,"rgba(0, 0, 0, 0)"),M.addColorStop(b,"rgba(0, 0, 0, 0.8)"),M.addColorStop(1,"rgba(0, 0, 0, 0)"),ctx.fillStyle=M,ctx.beginPath(),ctx.moveTo(l,c),ctx.lineTo(l+g*d,c+y*d),ctx.lineTo(h+f*d,x+v*d),ctx.lineTo(h,x),ctx.closePath(),ctx.fill()}function drawPlanet(t){if(1==t.isGasPlanet)ctx.fillStyle=t.color0,ctx.beginPath(),ctx.arc(t.x,t.y,t.radius,0,2*Math.PI),ctx.fill(),drawAtmosphere(t.x,t.y,t.radius,t.atmoRadius,t.colorAtmo);else{ctx.fillStyle=t.colorOuter,ctx.beginPath();for(var e=t.heights.length,r=0;r<e;r++){var a=r/e*2*Math.PI,i=Math.cos(a),s=Math.sin(a),o=t.heights[r]+15;i=i*t.radius+i*o+t.x,s=s*t.radius+s*o+t.y,0==r?ctx.moveTo(i,s):ctx.lineTo(i,s)}ctx.closePath(),ctx.fill()}if(null!=t.cities&&t.cities.length>0)for(r=0;r<t.cities.length;r++){var n=t.cities[r],l=n.x*t.radius*.98+t.x,c=n.y*t.radius*.98+t.y,h=-n.y,x=n.x;o=3*n.size;0==n.side?(ctx.fillStyle="rgb("+n.tone+", "+n.tone+", "+n.tone+")",ctx.strokeStyle="rgb(200, 200, 200)",ctx.beginPath(),ctx.moveTo(l-h*n.size,c-x*n.size),ctx.lineTo(l+h*n.size,c+x*n.size),ctx.lineTo(l+h*n.size+n.x*o,c+x*n.size+n.y*o),ctx.lineTo(l-h*n.size+n.x*o,c-x*n.size+n.y*o),ctx.lineTo(l-h*n.size,c-x*n.size),ctx.fill(),ctx.stroke()):(ctx.fillStyle="rgb("+n.tone+", "+.5*n.tone+", "+.5*n.tone+")",ctx.strokeStyle="rgb(200, 128, 128)",ctx.beginPath(),ctx.moveTo(l-h*n.size*.5,c-x*n.size*.5),ctx.lineTo(l+h*n.size*.5,c+x*n.size*.5),ctx.lineTo(l+h*n.size*.5+n.x*o,c+x*n.size*.5+n.y*o),ctx.lineTo(l-h*n.size*.5+n.x*o,c-x*n.size*.5+n.y*o),ctx.fill(),ctx.beginPath(),ctx.arc(l,c,1*n.size,0,2*Math.PI),ctx.stroke())}}function drawPlanetOver(t){if(!t.isGasPlanet){ctx.fillStyle=t.colorInner,ctx.beginPath();for(var e=t.heights.length,r=0;r<e;r++){var a=r/e*2*Math.PI,i=Math.cos(a),s=Math.sin(a),o=t.bheights[r]+5;i=i*t.radius+i*o+t.x,s=s*t.radius+s*o+t.y,0==r?ctx.moveTo(i,s):ctx.lineTo(i,s)}ctx.closePath(),ctx.fill(),ctx.fillStyle=t.colorDetail,ctx.beginPath(),ctx.arc(t.x,t.y,t.radius,0,2*Math.PI),ctx.fill()}t.atmoRadius>=0&&drawAtmosphere(t.x,t.y,t.radius,t.atmoRadius,t.colorAtmo)}function drawPlanetMap(t){var e=planets[t.center];ctx.strokeStyle=t.orbitColor,ctx.fillStyle=t.orbitColor,ctx.lineWidth=1/camera.zoom,ctx.beginPath(),ctx.arc(e.x,e.y,t.orbitRadius,0,2*Math.PI),ctx.stroke(),ctx.beginPath(),ctx.arc(t.x,t.y,t.radius,0,2*Math.PI),ctx.fill();var r=2/camera.zoom;if(0!=t.center&&(r=camera.zoom<=.04?0:1/camera.zoom),r>0){var a=4*t.name.length*r;drawText(t.name,t.x-a/2,t.y+Math.max(t.atmoRadius,1.1*t.radius),r,t.orbitColor)}}function createRing(t,e,r,a){var i=(Math.PI*r*r-Math.PI*e*e)*a,s=Array();i>=64&&(i=64);for(var o=0;o<i;o++){var n=rrg(e,r),l=rrg(-1e4,1e4),c=rrg(5,50),h=randomColor(2,.6);s.push({orbitRadius:n,offset:l,size:c,color:h})}return{center:t,minRadius:e,maxRadius:r,rocks:s}}function maxCameraReach(){return Math.max(canvas.width,canvas.height)/camera.zoom}function drawRing(t,e){var r=planets[t.center].x,a=planets[t.center].y;if(camera.zoom>=.01&&distance(camera.x,camera.y,r,a)<=maxCameraReach()+t.maxRadius)for(var i=0;i<t.rocks.length;i++){var s=t.rocks[i],o=orbit(r,a,planets[t.center].mass,.001,s.orbitRadius,e+s.offset);ctx.fillStyle=s.color,ctx.beginPath(),ctx.arc(o.x,o.y,s.size,0,2*Math.PI),ctx.fill()}}function createShip(t,e,r,a){let i=[2,11,50,100,50,.8,8,100,200,150,.6,6,400,250,80];seed=e;var s,o,n={},l=Array(),c=Array(),h=Array();if(0==t){var x=(s=(o=.5*rrg(50,100))*rrg(100,140)*.01)/(2*o);l.push({x:-o/2,y:0}),l.push({x:o/2,y:0}),l.push({x:0,y:s}),l.push({x:.5*s*x,y:.5*s}),l.push({x:.8*o,y:.5*s}),l.push({x:.8*-o,y:.5*s}),l.push({x:0,y:2*s}),l.push({x:.8*o,y:.5*s}),l.push({x:.5*s*x,y:.5*s}),l.push({x:0,y:s});var d=o*rrg(30,70)*.005;h.push({x:-d,y:0,size:6,t:0,dir:0}),h.push({x:d,y:0,size:6,t:0,dir:0}),h.push({x:0,y:2*s,size:6,t:0,dir:Math.PI}),h.push({x:0,y:2*s,size:6,t:0,dir:Math.PI/2}),h.push({x:0,y:2*s,size:6,t:0,dir:-Math.PI/2}),h.push({x:d,y:0,size:6,t:0,dir:Math.PI/2}),h.push({x:-d,y:0,size:6,t:0,dir:-Math.PI/2});var p=(g=rrg(60,90)*s*.01)*x*.5;c.push({x:p,y:g,dir:0,size:6,angle:Math.PI/2.5,speed:8,ftime:.07,ftimer:0}),c.push({x:-p,y:g,dir:0,size:6,angle:Math.PI/2.5,speed:8,ftime:.07,ftimer:0})}else if(1==t){var m=(s=(o=.5*rrg(100,160))*rrg(140,180)*.01)*rrg(130,170)*.01,u=m-s;l.push({x:-o/2,y:0}),l.push({x:o/2,y:0}),l.push({x:o/2,y:s}),l.push({x:-o/2,y:s}),l.push({x:o/8,y:s}),l.push({x:o/8,y:m}),l.push({x:-o/8,y:m}),l.push({x:-o/8,y:s}),l.push({x:-o/2,y:s});d=o*rrg(30,70)*.05,d=o*rrg(30,70)*.005;h.push({x:-d,y:0,size:12,t:0,dir:0}),h.push({x:d,y:0,size:12,t:0,dir:0}),h.push({x:0,y:.8*u+s,size:7,t:0,dir:Math.PI}),h.push({x:0,y:.8*u+s,size:7,t:0,dir:Math.PI/2}),h.push({x:0,y:.8*u+s,size:7,t:0,dir:-Math.PI/2}),h.push({x:d,y:0,size:7,t:0,dir:Math.PI/2}),h.push({x:-d,y:0,size:7,t:0,dir:-Math.PI/2});var g=rrg(70,100)*s*.01;p=rrg(50,80)*o*.005;c.push({x:p,y:g,dir:0,size:12,angle:Math.PI/2,speed:4,ftime:.3,ftimer:0}),c.push({x:-p,y:g,dir:0,size:12,angle:Math.PI/2,speed:4,ftime:.3,ftimer:0});g=rrg(30,60)*s*.01,p=rrg(50,80)*o*.005;c.push({x:p,y:g,dir:-Math.PI/2,size:16,angle:Math.PI/2,speed:2,ftime:.5,ftimer:0}),c.push({x:-p,y:g,dir:Math.PI/2,size:16,angle:Math.PI/2,speed:2,ftime:.5,ftimer:0})}else if(2==t){s=(o=.5*rrg(180,260))*rrg(200,320)*.01;var y=o*rrg(40,70)*.01,f=rrg(30,60)*s*.01;l.push({x:o/2,y:0}),l.push({x:y/2,y:f}),l.push({x:o/2,y:s}),l.push({x:0,y:1.1*s}),l.push({x:-o/2,y:s}),l.push({x:-y/2,y:f}),l.push({x:-o/2,y:0}),h.push({x:0,y:0,size:20,t:0,dir:0}),h.push({x:o/2.2,y:0,size:14,t:0,dir:0}),h.push({x:-o/2.2,y:0,size:14,t:0,dir:0}),h.push({x:.5*-y,y:f,size:12,t:0,dir:-Math.PI/2}),h.push({x:.5*y,y:f,size:12,t:0,dir:Math.PI/2}),h.push({x:.5*-y,y:f,size:12,t:0,dir:1.15*Math.PI}),h.push({x:.5*y,y:f,size:12,t:0,dir:1.15*-Math.PI}),c.push({x:0,y:f,dir:0,size:32,angle:Math.PI,speed:2,ftime:1,ftimer:0}),c.push({x:y/2.2,y:1.8*f,dir:-Math.PI/2.5,size:20,angle:Math.PI/2,speed:2,ftime:.4,ftimer:0}),c.push({x:-y/2.2,y:1.8*f,dir:Math.PI/2.5,size:20,angle:Math.PI/2,speed:2,ftime:.4,ftimer:0}),c.push({x:y/1.8,y:.95*s,dir:0,size:12,angle:Math.PI/2.5,speed:4,ftime:.1,ftimer:0}),c.push({x:-y/1.8,y:.95*s,dir:0,size:12,angle:Math.PI/2.5,speed:4,ftime:.1,ftimer:0})}var v=1+.11*a;n.maneouver=i[5*t+0]*v,n.speed=i[5*t+1]*v,n.armor=i[5*t+2]*v,n.fuel=i[5*t+3]*v,n.cargo=i[5*t+4]*v;for(var M=n.armor,b=0;b<c.length;b++)c[b].size*=v,c[b].ftime/=v/2;var z=.01*rrg(14,25),P=sideColor(r);return{health:M,destroyed:!1,type:t,stats:n,hull:l,weapons:c,thrusters:h,width:o,length:s,x:0,y:0,rot:Math.PI,angspeed:0,speed:{x:0,y:0},thrust:{fw:0,side:0,rot:0},acc:{x:0,y:0},landed:!1,scale:z,firing:!1,side:r,color:P,ai:{task:null,obj:null,beh:null,level:a,target:-1,targetTimer:0}}}function drawShipLow(t){ctx.fillStyle=t.color,ctx.strokeStyle="rgb(255, 255, 255)",ctx.lineWidth=2,ctx.beginPath(),ctx.moveTo(t.hull[0].x,t.hull[0].y);for(var e=1;e<t.hull.length;e++)ctx.lineTo(t.hull[e].x,t.hull[e].y);ctx.lineTo(t.hull[0].x,t.hull[0].y),ctx.fill(),ctx.stroke();for(e=0;e<t.thrusters.length;e++){ctx.fillStyle="rgb(60, 60, 60)",ctx.strokeStyle="rgb(255, 255, 255)",ctx.lineWidth=2;var r=t.thrusters[e],a=r.size,i=Math.cos(r.dir-Math.PI/2),s=Math.sin(r.dir-Math.PI/2),o=Math.cos(r.dir),n=Math.sin(r.dir),l=i*a*2+o*a*.7,c=s*a*2+n*a*.7,h=i*a*2-o*a*.7,x=s*a*2-n*a*.7;ctx.beginPath(),ctx.moveTo(r.x,r.y),ctx.lineTo(r.x+l,r.y+c),ctx.lineTo(r.x+h,r.y+x),ctx.lineTo(r.x,r.y),ctx.fill(),ctx.stroke(),ctx.beginPath(),ctx.arc(r.x,r.y,a,0,2*Math.PI),ctx.fill(),ctx.stroke()}for(e=0;e<t.weapons.length;e++){ctx.fillStyle="rgb(170, 90, 90)",ctx.strokeStyle="rgb(255, 255, 255)",ctx.lineWidth=2;var d=t.weapons[e],p=d.size;ctx.beginPath(),ctx.rect(d.x-p/2,d.y-p/2,p,p),ctx.fill(),ctx.stroke(),ctx.beginPath(),ctx.lineWidth=4,ctx.moveTo(d.x,d.y);var m=1.5*p;ctx.lineTo(d.x+m*Math.cos(d.rdir+Math.PI/2-t.rot),d.y+m*Math.sin(d.rdir+Math.PI/2-t.rot)),ctx.stroke()}}function drawShip(t){ctx.translate(t.x,t.y),ctx.scale(t.scale,t.scale),ctx.rotate(t.rot),ctx.translate(0,-t.length/2),drawShipLow(t),ctx.setTransform(1,0,0,1,0,0),doCameraTransform()}function drawShipExhaust(t){ctx.translate(t.x,t.y),ctx.scale(t.scale,t.scale),ctx.rotate(t.rot),ctx.translate(0,-t.length/2);for(var e=0;e<t.thrusters.length;e++){ctx.fillStyle="rgb(255, 255, 255)",ctx.strokeStyle="rgb(180, 180, 255)",ctx.lineWidth=2;var r=t.thrusters[e],a=r.size,i=Math.cos(r.dir-Math.PI/2),s=Math.sin(r.dir-Math.PI/2),o=Math.cos(r.dir),n=Math.sin(r.dir),l=i*a*2+o*a*.7,c=s*a*2+n*a*.7,h=i*a*2-o*a*.7,x=s*a*2-n*a*.7,d=8*(r.t+0);ctx.beginPath(),ctx.lineTo(r.x+l,r.y+c),ctx.lineTo(r.x+i*(d+2)*a,r.y+a*(d+2)*s),ctx.lineTo(r.x+h,r.y+x),ctx.fill(),ctx.stroke()}ctx.setTransform(1,0,0,1,0,0),doCameraTransform()}function xvals(t){var e=0,r=0;return t>=0?e=t:r=-t,{a:e,b:r}}function setShipThrust(t){var e=xvals(t.thrust.rot),r=xvals(t.thrust.side),a=xvals(t.thrust.fw);2==t.type?(t.thrusters[0].t=a.a,t.thrusters[2].t=Math.max(e.b,a.a),t.thrusters[1].t=Math.max(e.a,a.a),t.thrusters[3].t=r.b,t.thrusters[4].t=r.a,t.thrusters[5].t=a.b,t.thrusters[6].t=a.b):(t.thrusters[0].t=a.a,t.thrusters[1].t=a.a,t.thrusters[2].t=a.b,t.thrusters[3].t=Math.max(r.a,e.a),t.thrusters[4].t=Math.max(r.b,e.b),t.thrusters[5].t=Math.max(r.a,e.b),t.thrusters[6].t=Math.max(r.b,e.a))}function aimShipGuns(t,e,r){for(var a=e.x-t.x,i=e.y-t.y,s=0;s<t.weapons.length;s++){var o=t.weapons[s],n=t.rot;o.dir=sanitizeAngle(o.dir);var l=n+o.dir+Math.PI/2;l=sanitizeAngle(l);var c=Math.cos(l),h=Math.sin(l),x=o.dir+n,d=Math.atan2(i-h,a-c),p=Math.atan2(i,a)-Math.atan2(h,c);p>Math.PI?p-=2*Math.PI:p<=-Math.PI&&(p+=2*Math.PI),Math.abs(p)<=o.angle?(o.wdir=d-.5*Math.PI,o.aim=!0):(o.wdir=x,o.aim=!1),null==o.rdir&&(o.rdir=x),o.rdir=o.wdir;var m=rotate(0,-t.length/2,t.rot),u=1.5*o.size,g=Math.cos(o.rdir+Math.PI/2),y=Math.sin(o.rdir+Math.PI/2),f=rotate(o.x*t.scale,o.y*t.scale,t.rot);f.x+=u*g*t.scale,f.y+=u*y*t.scale,o.muzzle={x:t.x+f.x+t.scale*m.x,y:t.y+f.y+t.scale*m.y,dx:g,dy:y}}}function predictShip(t){t.predict=[],t.collides=-1,t.predict.push({x:t.x,y:t.y,sx:t.speed.x,sy:t.speed.y,time:time});var e=.5,r=500,a=15;0==t.frame?(e=5,r=15e3,a=1500):0!=planets[t.frame].center&&(e=.25);for(var i=0,s=planetAtTime(t.frame,time),o=0;o<r/e;o++){var n={x:t.predict[o].x,y:t.predict[o].y},l={x:t.predict[o].sx,y:t.predict[o].sy},c=t.predict[o].time;c+=e,n.x+=l.x*e,n.y+=l.y*e;var h=gravity(n,c);l.x+=h.x*e,l.y+=h.y*e;var x=planetAtTime(t.frame,c),d={x:t.x+x.x-s.x,y:t.y+x.y-s.y},p=distance(n.x,n.y,d.x,d.y);if(p<i&&p<=a){t.predict.push(t.predict[0]);break}var m=collidesWithPlanet(n,c);if(null!=m){var u=planetAtTime(m.planet,c);t.predict.push({x:m.sx+u.x,y:m.sy+u.y,sx:0,sy:0,time:c}),t.collides=m.planet;break}t.predict.push({x:n.x,y:n.y,sx:l.x,sy:l.y,time:c}),i=p}}function getSpeedVectorRelative(t){var e=getPlanetSpeed(planets[t.frame],time);return{x:t.speed.x-e.x,y:t.speed.y-e.y}}function getProgradeVector(t){var e=getSpeedVectorRelative(t);return normalize(e.x,e.y)}function getAltitude(t){var e=planets[t.frame];return distance(0,0,t.x-e.x,t.y-e.y)}function getAltitudeGround(t){return getAltitude(t)-planets[t.frame].radius}function getProgradeAngle(t){var e=getProgradeVector(t);return Math.atan2(e.y,e.x)-Math.PI/2}function getFrameSpeed(t){var e=getSpeedVectorRelative(t);return distance(0,0,e.x,e.y)}function simulateShip(t,e){if(rrg(0,1e3)>=t.health/t.stats.armor*2e3&&burn(t.x+rrg(-10,10),t.y+rrg(-10,10),t.speed.x+rrg(-10,10),t.speed.y+rrg(-10,10),rrg(4,15),.005*rrg(100,200)),t.destroyed){if(t.thrust.fw=0,t.thrust.side=0,t.thrust.rot=0,t.firing=!1,t.health-=e,t.health<=-50)return!0}else t.health<=0&&(explode(t.x,t.y,t.speed.x,t.speed.y,rrg(100,400),.7,2,!0,!1,1),t.destroyed=!0,t.angspeed=.01*rrg(-400,400));if(setShipThrust(t),null==t.nograv&&(t.nograv=0),1==t.landed){var r=planetAtTime(t.coll.planet,time),a=planets[t.coll.planet],i=orbitVelocity(a.center,a.mass,a.orbitRadius,time,a.orbitOffset);t.x=r.x+t.coll.sx,t.y=r.y+t.coll.sy,t.speed.x=0,t.speed.y=0,(n=t.thrust.fw)>0&&(t.landed=!1,t.speed.x=15*t.coll.nx+i.x,t.speed.y=15*t.coll.ny+i.y,t.nograv=.1,t.x+=t.speed.x*e,t.y+=t.speed.y*e)}else{var s={x:t.x,y:t.y},o=collidesWithPlanet(s,time);null!=o&&(t.landed=!0,t.coll=o);var n=t.thrust.fw,l=t.thrust.side,c={x:Math.cos(t.rot+Math.PI/2),y:Math.sin(t.rot+Math.PI/2)},h={x:Math.cos(t.rot),y:Math.sin(t.rot)};if(t.speed.x+=c.x*n*t.stats.speed*e*5,t.speed.y+=c.y*n*t.stats.speed*e*5,t.speed.x+=h.x*-l*t.stats.speed*e*5,t.speed.y+=h.y*-l*t.stats.speed*e*5,t.angspeed+=t.stats.maneouver*e*t.thrust.rot,t.x+=t.speed.x*e,t.y+=t.speed.y*e,t.rot+=t.angspeed*e,t.nograv<0){var x=gravity(s,-1);t.speed.x+=x.x*e,t.speed.y+=x.y*e,t.acc=x}t.nograv-=e}for(var d=0;d<t.weapons.length;d++){if(t.firing&&1==t.weapons[d].aim&&t.weapons[d].ftimer<=0){var p=t.weapons[d],m=p.muzzle,u=normalize(m.dx,m.dy),g=p.size/8,y=(i=650-p.size/32*350,.45);if(t==ships[0])y=1;explode(m.x,m.y,t.speed.x+15*u.x,t.speed.y+15*u.y,4*g,1,.5,!0,!0,y),p.ftimer=p.ftime,shoot(m.x,m.y,u.x*i+t.speed.x,u.y*i+t.speed.y,t.side,g,10)}t.weapons[d].ftimer-=e}return!1}function drawShipMap(t){ctx.fillStyle="rgb(128, 255, 128)",ctx.beginPath(),ctx.arc(t.x,t.y,25,0,2*Math.PI),ctx.fill()}function explosionSound(t,e,r,a,i=.6){var s=distance(camera.x,camera.y,e,r),o=Math.min(Math.max(500/(10*s),.005),1),n=.05+1.7*t,l=Math.min(100/(460*Math.pow(t,2.6)),500);a||(n=.1+.67*t,l=rrg(150-.14*t,280-.14*t)),o*=i,zzfx(Math.min(4*o,1),0,rrg(l-200*t,2*l),n,-5,0,8,0,.81),a&&zzfx(Math.min(o*t*2,1),0,rrg(l,l+100),rrg(1,.1*t)*t*n*2,0,0,8,0,0)}function createStar(t,e,r,a,i){return{x:t,y:e,radius:r,color:a,outColor:i}}function drawStar(t){var e=ctx.createRadialGradient(t.x,t.y,t.radius/1.5,t.x,t.y,t.radius);e.addColorStop(0,t.color),e.addColorStop(1,t.outColor),ctx.fillStyle=e,ctx.beginPath(),ctx.arc(t.x,t.y,t.radius,0,2*Math.PI),ctx.fill()}canvas.addEventListener("wheel",onwheel),canvas.addEventListener("mousemove",mousemove,!1),canvas.addEventListener("mousedown",onmouse,!1),canvas.addEventListener("mouseup",onmouse,!1),document.onkeydown=document.onkeyup=onkey;